<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Cosmos DB Playground</title>

    <!-- Fonts: Outfit (display) + JetBrains Mono (code) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: {
                            DEFAULT: '#0078d4',
                            hover: '#106ebe',
                            light: '#deecf9'
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'SF Mono', 'Monaco', 'Cascadia Code', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>

    <!-- Codapi Widget -->
    <script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.js"></script>
    <script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/settings.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.css" />

    <!-- Pako for compression -->
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

    <!-- Prism.js for SQL syntax highlighting -->
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-sql.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ============================================
           COSMOS DARK ‚Äî Design Tokens
           ============================================ */
        :root {
            --bg-deepspace: #0a0e1a;
            --bg-nebula: #0f1629;
            --bg-card: #141b2d;
            --bg-card-hover: #1a2340;
            --bg-elevated: #1e2741;
            --bg-input: #111827;

            --border-dim: rgba(99, 130, 191, 0.12);
            --border-subtle: rgba(99, 130, 191, 0.20);
            --border-focus: #3b82f6;

            --text-primary: #e8ecf4;
            --text-secondary: #8d9bb5;
            --text-muted: #5b6a87;
            --text-accent: #60a5fa;

            --azure-400: #60a5fa;
            --azure-500: #3b82f6;
            --azure-600: #2563eb;
            --azure-700: #1d4ed8;
            --azure-glow: rgba(59, 130, 246, 0.25);

            --purple-400: #a78bfa;
            --purple-500: #8b5cf6;
            --teal-400: #2dd4bf;

            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.1);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --info: #60a5fa;
            --info-bg: rgba(96, 165, 250, 0.1);

            --glass: rgba(20, 27, 45, 0.80);
            --glass-border: rgba(99, 130, 191, 0.15);

            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(99, 130, 191, 0.08);
            --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.15);
            --shadow-button: 0 2px 8px rgba(59, 130, 246, 0.25);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --radius-full: 9999px;

            --font-display: 'Outfit', system-ui, sans-serif;
            --font-body: 'Outfit', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Cascadia Code', monospace;

            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--bg-deepspace);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Cosmic background grain */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Gradient orbs */
        body::after {
            content: '';
            position: fixed;
            top: -20%;
            left: -10%;
            width: 60vw;
            height: 60vw;
            background: radial-gradient(circle, rgba(59,130,246,0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .orb-purple {
            position: fixed;
            bottom: -15%;
            right: -10%;
            width: 50vw;
            height: 50vw;
            background: radial-gradient(circle, rgba(139,92,246,0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .main-wrapper {
            position: relative;
            z-index: 1;
        }

        /* ============================================
           HIDDEN UTILITY
           ============================================ */
        .hidden { display: none !important; }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px rgba(59,130,246,0.2); }
            50% { box-shadow: 0 0 20px rgba(59,130,246,0.4); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        @keyframes toast-slide-in {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes banner-slide-down {
            from { opacity: 0; transform: translateY(-1rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in { animation: fadeIn 0.2s ease; }

        .stagger-1 { animation: fadeInUp 0.6s var(--ease-out-expo) 0.1s both; }
        .stagger-2 { animation: fadeInUp 0.6s var(--ease-out-expo) 0.2s both; }
        .stagger-3 { animation: fadeInUp 0.6s var(--ease-out-expo) 0.3s both; }
        .stagger-4 { animation: fadeInUp 0.6s var(--ease-out-expo) 0.4s both; }
        .stagger-5 { animation: fadeInUp 0.6s var(--ease-out-expo) 0.5s both; }

        /* ============================================
           SCROLLBAR
           ============================================ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-nebula); }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .data-textarea::-webkit-scrollbar { width: 6px; }
        .data-textarea::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 4px; }
        .data-textarea::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
        .data-textarea::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .data-textarea.modified {
            border-left: 3px solid var(--warning);
            padding-left: 13px;
        }

        .file-upload-section.drag-over {
            border-color: var(--azure-500) !important;
            background-color: rgba(59,130,246,0.05) !important;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--azure-500), var(--azure-600));
            color: white;
            box-shadow: var(--shadow-button);
            border: 1px solid rgba(59,130,246,0.3);
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--azure-400), var(--azure-500));
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59,130,246,0.35);
        }
        .btn-primary:active:not(:disabled) {
            transform: scale(0.97);
        }
        .btn-primary:disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            border-color: var(--border-dim);
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--azure-500);
            color: var(--text-accent);
            background: var(--bg-card-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 7px 14px;
            font-size: 0.8125rem;
        }

        /* ============================================
           CARDS
           ============================================ */
        .cosmos-card {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .cosmos-card:hover {
            border-color: var(--border-subtle);
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        /* ============================================
           HEADER / HERO
           ============================================ */
        .hero-section {
            text-align: center;
            padding: 48px 24px 40px;
            position: relative;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center top, rgba(59,130,246,0.08) 0%, transparent 60%);
            pointer-events: none;
        }
        .hero-title {
            font-family: var(--font-display);
            font-size: clamp(1.75rem, 4vw, 2.75rem);
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.15;
            background: linear-gradient(135deg, #e8ecf4 30%, var(--azure-400) 70%, var(--purple-400) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 12px;
        }
        .hero-subtitle a {
            color: var(--text-accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        .hero-subtitle a:hover { text-decoration: underline; }

        /* Cosmos DB logo float animation */
        .cosmos-logo {
            animation: float 4s ease-in-out infinite;
        }

        /* ============================================
           DATASET SELECT
           ============================================ */
        .custom-select {
            appearance: none;
            background: var(--bg-input);
            border: 1.5px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 12px 40px 12px 16px;
            font-family: var(--font-body);
            font-size: 0.9375rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            cursor: pointer;
            width: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%238d9bb5' d='M6 8L0 2h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }
        .custom-select:hover { border-color: var(--azure-400); }
        .custom-select:focus {
            outline: none;
            border-color: var(--azure-500);
            box-shadow: 0 0 0 3px var(--azure-glow);
        }
        .custom-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* ============================================
           CODE EDITOR
           ============================================ */
        .code-editor {
            width: 100%;
            min-height: 220px;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            line-height: 1.7;
            background: var(--bg-input);
            border: 1.5px solid var(--border-dim);
            border-radius: 0;
            color: var(--text-primary);
            transition: all 0.2s ease;
            resize: vertical;
        }
        .code-editor:focus {
            outline: none;
            border-color: var(--azure-500);
            box-shadow: inset 0 0 0 1px var(--azure-glow);
        }
        .code-editor.modified {
            border-left: 3px solid var(--warning);
        }
        .code-editor::placeholder {
            color: var(--text-muted);
        }

        /* ============================================
           QUERY PILLS
           ============================================ */
        .query-pill {
            padding: 8px 18px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            font-family: var(--font-body);
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-accent);
            cursor: pointer;
            transition: all 0.25s var(--ease-out-expo);
            white-space: nowrap;
        }
        .query-pill:hover {
            background: linear-gradient(135deg, var(--azure-500), var(--purple-500));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59,130,246,0.3);
        }
        .query-pill:active { transform: scale(0.96); }

        /* ============================================
           TOASTS
           ============================================ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            animation: toast-slide-in 0.3s var(--ease-out-expo);
        }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--error); }
        .toast-warning { border-left: 4px solid var(--warning); }
        .toast-info { border-left: 4px solid var(--info); }

        /* ============================================
           BANNERS
           ============================================ */
        .banner {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            border-left: 4px solid;
            animation: banner-slide-down 0.3s ease;
            margin-bottom: 20px;
        }
        .banner-info {
            background: var(--info-bg);
            border-color: var(--info);
        }
        .banner-warning {
            background: var(--warning-bg);
            border-color: var(--warning);
        }
        .banner-success {
            background: var(--success-bg);
            border-color: var(--success);
        }

        /* ============================================
           SECTION HEADERS
           ============================================ */
        .section-label {
            font-family: var(--font-display);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .section-title {
            font-family: var(--font-display);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ============================================
           CODAPI OVERRIDES (dark theme)
           ============================================ */
        codapi-snippet {
            --codapi-font: var(--font-mono);
            --codapi-color: var(--text-primary);
            --codapi-bg: var(--bg-input);
            --codapi-border: var(--border-dim);
            --codapi-radius: var(--radius-md);
        }
        /* Override codapi run button */
        codapi-snippet button[class*="run"],
        codapi-snippet .toolbar button {
            font-family: var(--font-body) !important;
        }

        /* Prism dark overrides */
        pre[class*="language-"],
        code[class*="language-"] {
            font-family: var(--font-mono) !important;
            font-size: 0.8125rem !important;
        }

        /* ============================================
           DIVIDER LINE
           ============================================ */
        .section-divider {
            border: none;
            border-top: 1px solid var(--border-dim);
        }

        /* ============================================
           DETAILS/SUMMARY
           ============================================ */
        details summary {
            list-style: none;
        }
        details summary::-webkit-details-marker { display: none; }
        details summary::before {
            content: '‚ñ∏';
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s ease;
            color: var(--text-muted);
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }

        /* ============================================
           ACCESSIBILITY
           ============================================ */
        *:focus-visible {
            outline: 2px solid var(--azure-500);
            outline-offset: 2px;
        }
        .btn:focus-visible {
            outline: 3px solid var(--azure-400);
            outline-offset: 3px;
        }
        .sr-only {
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap; border: 0;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 640px) {
            .custom-select, .code-editor { font-size: 16px; }
            .button-group { flex-direction: column; width: 100%; }
            .button-group .btn { width: 100%; }
            .query-pill { padding: 6px 14px; font-size: 0.75rem; }
            .toast { bottom: 12px; right: 12px; left: 12px; }
            .hero-section { padding: 32px 16px 28px; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ============================================
           FOOTER
           ============================================ */
        .footer-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }
        .footer-link:hover { color: var(--text-accent); }
    </style>
</head>

<body>
    <div class="orb-purple"></div>

    <script>
        // Auto-detect environment and write codapi-settings element with correct URL
        const isLocal = window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.protocol === 'file:';

        const codapiUrl = isLocal
            ? 'http://localhost/v1'
            : `${window.location.protocol}//${window.location.host}/v1`;

        document.write('<codapi-settings url="' + codapiUrl + '"></codapi-settings>');
    </script>

    <!-- Main Wrapper -->
    <div class="main-wrapper max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Top Navigation -->
        <nav class="flex justify-end items-center mb-6 stagger-1">
            <a href="https://github.com/abhirockzz/cosmosdb-playground" target="_blank"
                class="btn btn-secondary" style="font-size:0.8125rem;">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                Star on GitHub
            </a>
        </nav>

        <!-- Hero Section -->
        <header class="hero-section stagger-1">
            <div class="flex items-center justify-center gap-3 mb-4">
                <img src="https://raw.githubusercontent.com/AzureCosmosDB/gallery/main/static/img/cosmos.png"
                    alt="Azure Cosmos DB" class="h-12 w-12 cosmos-logo">
                <h1 class="hero-title">Azure Cosmos DB Playground</h1>
            </div>
            <p class="hero-subtitle">
                Powered by
                <a href="https://learn.microsoft.com/azure/cosmos-db/emulator-linux" target="_blank">Azure Cosmos DB vNext Emulator</a>
                and
                <a href="https://codapi.org/" target="_blank">Codapi</a>
            </p>
        </header>

        <!-- URL Loaded Banner -->
        <div id="url-loaded-banner" class="hidden banner banner-warning">
            <p class="text-sm" style="color: var(--warning);">
                ‚ú® Code loaded from shared link. You can edit and experiment freely!
            </p>
        </div>

        <!-- Session Restore Banner -->
        <div id="session-restore-banner" class="hidden banner banner-info">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <p class="text-sm font-medium" style="color: var(--info);">
                        üìù Welcome back! You have a previous session.
                    </p>
                    <p id="session-restore-details" class="text-xs" style="color: var(--text-secondary); margin-top: 4px;"></p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="restoreSession()" class="btn btn-primary btn-sm">Restore</button>
                    <button onclick="dismissSessionRestore()" class="btn btn-secondary btn-sm">Start Fresh</button>
                </div>
            </div>
        </div>

        <!-- Intro Text -->
        <p class="stagger-2" style="color: var(--text-secondary); text-align: center; max-width: 560px; margin: 0 auto 32px; font-size: 0.9375rem; line-height: 1.6;">
            Experiment with
            <a href="https://learn.microsoft.com/en-us/cosmos-db/query/overview" target="_blank"
                style="color: var(--text-accent); text-decoration: none; font-weight: 500;">Cosmos DB SQL queries</a>
            interactively. Choose a preset dataset or load your own data.
        </p>

        <!-- Main Content Card -->
        <div class="cosmos-card stagger-3">

            <!-- Dataset Section -->
            <div style="padding: 28px 28px 24px; border-bottom: 1px solid var(--border-dim);">
                <div class="flex items-center gap-2 mb-4">
                    <span style="font-size: 1.25rem;">üìä</span>
                    <h2 class="section-title">Sample Data</h2>
                </div>

                <!-- Dataset Selector -->
                <div style="margin-bottom: 16px;">
                    <label for="dataset-picker" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">
                        Choose a Dataset
                    </label>
                    <select id="dataset-picker" onchange="loadPresetDataset()" class="custom-select"
                        aria-label="Select a preset dataset or choose custom data">
                        <option value="simple">Simple Demo (3 items)</option>
                        <option value="products">E-commerce Products (10 items)</option>
                        <option value="iot">IoT Device Telemetry (45 items)</option>
                        <option value="movies">Movie Database (50 items)</option>
                        <option value="embed">Blog Posts - Embedded Data Model (8 items)</option>
                        <option value="reference">Order System - Referenced Data Model (17 items)</option>
                        <option value="hybrid">Conference System - Hybrid Data Model (10 items)</option>
                        <option value="custom">Custom Data</option>
                    </select>
                </div>

                <!-- Dataset Info -->
                <div id="dataset-info"
                    style="font-size: 0.8125rem; color: var(--text-secondary); background: var(--bg-elevated); border-radius: var(--radius-md); padding: 12px 16px; border: 1px solid var(--border-dim); line-height: 1.5;">
                    Basic user records with name, city, and age. Perfect for learning SQL query basics.
                </div>
            </div>

            <!-- Query Suggestions -->
            <div id="query-suggestions" class="hidden" style="padding: 20px 28px; border-bottom: 1px solid var(--border-dim); background: rgba(59,130,246,0.02);">
                <h4 style="font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>üí°</span> Try these queries:
                </h4>
                <div id="query-buttons-container" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Partition Key Info -->
            <details style="border-bottom: 1px solid var(--border-dim);">
                <summary style="padding: 16px 28px; cursor: pointer; font-size: 0.8125rem; font-weight: 500; color: var(--text-secondary); transition: color 0.2s; user-select: none;">
                    About Partition Keys in this Playground
                </summary>
                <div style="padding: 0 28px 16px; font-size: 0.8125rem; color: var(--text-muted); line-height: 1.7;">
                    <p style="margin-bottom: 8px;">
                        This playground uses <code style="background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.75rem;">/id</code> as
                        the partition key for all queries. This works with any JSON data since
                        the <code style="background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.75rem;">id</code> field is auto-generated if missing.
                    </p>
                    <p>
                        <strong style="color: var(--text-secondary);">In production Cosmos DB:</strong> Choose partition keys based on your
                        query patterns (e.g., <code style="background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.75rem;">/tenantId</code>,
                        <code style="background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.75rem;">/userId</code>).
                        <a href="https://learn.microsoft.com/azure/cosmos-db/partitioning-overview" target="_blank"
                            style="color: var(--text-accent); text-decoration: none;">Learn more ‚Üí</a>
                    </p>
                </div>
            </details>

            <!-- File Upload Section (hidden by default) -->
            <div id="file-upload-section" class="hidden file-upload-section" style="padding: 24px 28px; border-bottom: 1px solid var(--border-dim);">
                <div style="border: 2px dashed var(--border-subtle); border-radius: var(--radius-lg); padding: 32px; text-align: center; transition: all 0.2s;">
                    <input type="file" id="data-file-picker" accept=".json,application/json"
                        style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 12px;">
                    <button id="load-file-btn" onclick="loadFromFile()" class="btn btn-primary">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Load from File
                    </button>
                </div>
                <div id="status-message" class="hidden" style="margin-top: 12px; padding: 8px 16px; border-radius: var(--radius-md); font-size: 0.8125rem;"></div>
            </div>

            <!-- Hidden script tag for codapi to reference -->
            <script id="data.json" type="text/plain">
[
  {"id": "1", "name": "Alice", "city": "New York", "age": 30},
  {"id": "2", "name": "Bob", "city": "London", "age": 25},
  {"id": "3", "name": "Charlie", "city": "London", "age": 35}
]
            </script>

            <!-- Data Editor -->
            <div style="border-bottom: 1px solid var(--border-dim);">
                <label for="data-textarea" class="sr-only">Edit JSON data</label>
                <textarea id="data-textarea"
                    class="data-textarea code-editor"
                    aria-label="JSON data editor"
                    placeholder="Paste or edit your JSON data here..." oninput="handleDataEdit()">[
  {"id": "1", "name": "Alice", "city": "New York", "age": 30},
  {"id": "2", "name": "Bob", "city": "London", "age": 25},
  {"id": "3", "name": "Charlie", "city": "London", "age": 35}
]</textarea>
                <div style="padding: 12px 20px; background: var(--bg-nebula); border-top: 1px solid var(--border-dim); display: flex; align-items: center; gap: 12px;">
                    <button id="apply-button" onclick="applyDataChanges()" disabled class="btn btn-primary btn-sm">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Apply Changes
                    </button>
                    <div id="data-status" class="hidden" style="font-size: 0.8125rem; padding: 4px 12px; border-radius: var(--radius-md);"></div>
                </div>
            </div>

            <!-- SQL Query Section -->
            <div style="padding: 28px;">
                <div class="flex items-center gap-2 mb-4">
                    <span style="font-size: 1.25rem;">‚ö°</span>
                    <h2 class="section-title">SQL Query</h2>
                </div>

                <pre style="background: var(--bg-input); border: 1px solid var(--border-dim); border-radius: var(--radius-md); padding: 16px 20px; overflow-x: auto; margin-bottom: 16px;"><code id="query-display" class="language-sql" style="font-size: 0.8125rem;">SELECT * FROM c WHERE c.city = 'London'</code></pre>

                <!-- Codapi Widget -->
                <codapi-snippet sandbox="cosmosdb" command="run" editor="basic" files="#data.json">
                </codapi-snippet>
            </div>

            <!-- Share Section -->
            <div style="padding: 24px 28px; border-top: 1px solid var(--border-dim); background: var(--bg-nebula);">
                <div class="flex items-center gap-2 mb-2">
                    <span>üîó</span>
                    <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">Share with others</h3>
                </div>
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 16px;">
                    Generate a shareable link. Perfect for blog posts, tutorials, and more!
                </p>
                <!-- Share row -->
                <div class="flex flex-wrap items-center gap-3 mb-3 button-group">
                    <button onclick="generateShareLink()" class="btn btn-primary">
                        <i data-lucide="link" class="w-4 h-4"></i>
                        Generate Link
                    </button>
                    <div id="share-buttons" class="hidden flex items-center gap-2">
                        <button onclick="copyShareLink()" class="btn btn-secondary">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            Copy Link
                        </button>
                        <button onclick="openShareLink()" class="btn btn-secondary">
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                            Open Link
                        </button>
                    </div>
                </div>
                <!-- Export/Import row -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Export/Import buttons hidden: feature temporarily unavailable -->
                    <!--
                    <button onclick="exportSession()"
                        class="btn btn-secondary">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export to File
                    </button>
                    <button onclick="document.getElementById('import-file-picker').click()"
                        class="btn btn-secondary">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Import from File
                    </button>
                    <input type="file" id="import-file-picker" accept=".json,application/json" class="hidden"
                        onchange="importSession()">
                    -->
                </div>
                <div id="share-status" class="hidden" style="margin-top: 12px; font-size: 0.8125rem; padding: 4px 12px; border-radius: var(--radius-md);"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="stagger-5" style="margin-top: 48px; padding-top: 24px; border-top: 1px solid var(--border-dim); text-align: center; font-size: 0.8125rem; color: var(--text-muted);">
            <p>Built with ‚ù§Ô∏è for the Azure Cosmos DB community</p>
        </footer>
    </div>

    <!-- Screen Reader Live Region -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
        <span id="screen-reader-status"></span>
    </div>

    <script>
        // Preset Datasets (metadata only - data loaded from external JSON files)
        const presetDatasets = {
            simple: {
                description: "Basic user records with name, city, and age. Perfect for learning SQL query basics."
            },
            products: {
                description: "Product catalog with nested objects, arrays, and complex queries. Includes inventory, specs, and reviews."
            },
            iot: {
                description: "Time-series data from IoT devices including temperature, humidity, and status metrics."
            },
            movies: {
                description: "Classic and contemporary films with genres, directors, actors, ratings, and awards."
            },
            embed: {
                description: "Demonstrates embedded data modeling pattern where related data is stored within a single document. Blog posts with embedded author details, comments array, and tags. This pattern is ideal when data is always accessed together, reducing the need for joins and improving query performance. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#embed-data"
            },
            reference: {
                description: "Demonstrates referenced data modeling pattern where related data is stored in separate documents and linked via IDs. Orders reference customers and products rather than embedding them. This pattern is ideal when data changes frequently, is accessed independently, or could grow unbounded. Avoids data duplication and enables independent updates. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#reference-data"
            },
            hybrid: {
                description: "Demonstrates hybrid data modeling pattern combining embedded and referenced data based on access patterns. Conferences embed session details (always accessed together) but reference speaker documents (shared across sessions, updated independently). This approach balances the benefits of both patterns for optimal performance. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#hybrid-data-models"
            },
            custom: {
                description: "Experiment with your data."
            }
        };

        let currentShareUrl = '';
        let originalData = '';
        let originalQuery = '';
        let lastSelectedPreset = 'simple';
        let currentDatasetKey = 'simple';
        let originalPresetData = null;
        let originalPresetQueries = [];
        let pendingSessionRestore = null;

        const SESSION_STORAGE_KEY = 'cosmosdb-playground-session';
        const SESSION_TTL_DAYS = 7;

        function resetShareLink() {
            currentShareUrl = '';
            document.getElementById('share-buttons').classList.add('hidden');
        }

        function saveSession() {
            try {
                const textarea = document.getElementById('data-textarea');
                const queryDisplay = document.getElementById('query-display');
                const snippet = document.querySelector('codapi-snippet');

                const currentData = textarea ? textarea.value.trim() : '';
                const currentQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';

                const isDataModified = currentDatasetKey === 'custom' ||
                    (originalPresetData && currentData !== JSON.stringify(originalPresetData, null, 2));

                const isQueryUnchanged = currentQuery === originalQuery ||
                    (originalPresetQueries.length > 0 && originalPresetQueries.some(q => q === currentQuery));

                if (!isDataModified && isQueryUnchanged) {
                    clearSession();
                    return;
                }

                const session = {
                    datasetKey: currentDatasetKey,
                    data: currentData,
                    query: currentQuery,
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (SESSION_TTL_DAYS * 24 * 60 * 60 * 1000)
                };

                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn('Session auto-save failed: localStorage quota exceeded');
                }
            }
        }

        function loadSession() {
            try {
                const stored = localStorage.getItem(SESSION_STORAGE_KEY);
                if (!stored) return null;

                const session = JSON.parse(stored);

                if (session.expiresAt && Date.now() > session.expiresAt) {
                    clearSession();
                    return null;
                }

                return session;
            } catch (e) {
                clearSession();
                return null;
            }
        }

        function clearSession() {
            try {
                localStorage.removeItem(SESSION_STORAGE_KEY);
            } catch (e) { }
        }

        function showSessionRestoreBanner(session) {
            const banner = document.getElementById('session-restore-banner');
            const details = document.getElementById('session-restore-details');

            if (!banner || !session) return;

            const minutesAgo = Math.floor((Date.now() - session.timestamp) / (1000 * 60));
            let timeAgo;
            if (minutesAgo < 1) {
                timeAgo = 'just now';
            } else if (minutesAgo < 60) {
                timeAgo = `${minutesAgo} minute${minutesAgo === 1 ? '' : 's'} ago`;
            } else if (minutesAgo < 1440) {
                const hours = Math.floor(minutesAgo / 60);
                timeAgo = `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else {
                const days = Math.floor(minutesAgo / 1440);
                timeAgo = `${days} day${days === 1 ? '' : 's'} ago`;
            }

            const datasetLabel = session.datasetKey === 'custom' ? 'custom data' : `${session.datasetKey} dataset (modified)`;
            details.textContent = `Last saved ${timeAgo} with ${datasetLabel}`;

            pendingSessionRestore = session;
            banner.classList.remove('hidden');
        }

        function restoreSession() {
            if (!pendingSessionRestore) return;

            const session = pendingSessionRestore;
            const textarea = document.getElementById('data-textarea');
            const scriptTag = document.getElementById('data.json');
            const queryDisplay = document.getElementById('query-display');
            const snippet = document.querySelector('codapi-snippet');
            const datasetPicker = document.getElementById('dataset-picker');

            if (session.data) {
                if (textarea) textarea.value = session.data;
                if (scriptTag) scriptTag.textContent = session.data;
                originalData = session.data;
            }

            if (session.query) {
                if (queryDisplay) queryDisplay.textContent = session.query;
                if (snippet) {
                    const editor = snippet.querySelector('.snippet-code');
                    if (editor) editor.textContent = session.query;
                }
            }

            if (session.datasetKey) {
                currentDatasetKey = session.datasetKey;
                if (datasetPicker) {
                    datasetPicker.value = session.datasetKey;
                    if (session.datasetKey === 'custom') {
                        document.getElementById('query-suggestions')?.classList.add('hidden');
                    }
                }
            }

            dismissSessionRestore();
            showDataStatus('‚úì Previous session restored', false);
        }

        function dismissSessionRestore() {
            const banner = document.getElementById('session-restore-banner');
            if (banner) banner.classList.add('hidden');
            pendingSessionRestore = null;
            if (!arguments[0]) { }
        }

        function setupAutoSave() {
            let saveTimeout = null;
            const debouncedSave = () => {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveSession, 2000);
            };

            const textarea = document.getElementById('data-textarea');
            if (textarea) {
                textarea.addEventListener('input', debouncedSave);
            }

            const originalApplyDataChanges = window.applyDataChanges;
            window.applyDataChanges = function () {
                originalApplyDataChanges.apply(this, arguments);
                saveSession();
            };

            const snippet = document.querySelector('codapi-snippet');
            if (snippet) {
                const observer = new MutationObserver(() => {
                    debouncedSave();
                    resetShareLink();
                });
                observer.observe(snippet, { childList: true, subtree: true, characterData: true });

                snippet.addEventListener('input', () => {
                    debouncedSave();
                    resetShareLink();
                }, true);
            }

            window.addEventListener('beforeunload', saveSession);
        }

        async function loadPresetDataset() {
            const selector = document.getElementById('dataset-picker');
            const datasetKey = selector.value;
            const fileSection = document.getElementById('file-upload-section');
            const querySection = document.getElementById('query-suggestions');

            if (datasetKey === 'custom') {
                const textarea = document.getElementById('data-textarea');
                const currentData = textarea.value.trim();
                const hasUnsavedChanges = currentData && currentData !== originalData.trim();

                if (hasUnsavedChanges) {
                    const confirmed = confirm('This will clear your current data. Continue?');
                    if (!confirmed) {
                        selector.value = lastSelectedPreset;
                        loadPresetDataset();
                        return;
                    }
                }

                fileSection.classList.remove('hidden');
                querySection.classList.add('hidden');
                textarea.value = '';
                textarea.placeholder = 'Paste your JSON data here...\n\nOr use the file upload option above.';
                textarea.classList.remove('modified');
                originalData = '';
                currentDatasetKey = 'custom';
                originalPresetData = null;
                originalPresetQueries = [];
                const infoDiv = document.getElementById('dataset-info');
                if (infoDiv) infoDiv.innerHTML = presetDatasets.custom.description;
                const snippet = document.querySelector('codapi-snippet');
                const queryDisplay = document.getElementById('query-display');
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
                const applyButton = document.getElementById('apply-button');
                applyButton.disabled = true;
                const scriptTag = document.getElementById('data.json');
                if (scriptTag) scriptTag.textContent = '';
                showDataStatus('üìã Upload a JSON file or paste your data below', false);
                return;
            } else {
                fileSection.classList.add('hidden');
                lastSelectedPreset = datasetKey;
            }

            let dataset;
            try {
                showDataStatus('Loading dataset...', false);
                const response = await fetch(`datasets/${datasetKey}.json`);
                if (!response.ok) throw new Error('Failed to load dataset file');
                dataset = await response.json();
            } catch (error) {
                console.warn(`Failed to load external dataset file for ${datasetKey}:`, error);
                showDataStatus('‚ùå Failed to load dataset', true);
                return;
            }

            const infoDiv = document.getElementById('dataset-info');
            infoDiv.innerHTML = dataset.description;

            currentDatasetKey = datasetKey;
            originalPresetData = dataset.data;
            originalPresetQueries = dataset.queries ? dataset.queries.map(q => q.query) : [];

            const prettyData = JSON.stringify(dataset.data, null, 2);

            const scriptTag = document.getElementById('data.json');
            if (scriptTag) {
                scriptTag.textContent = prettyData;
            }

            const textarea = document.getElementById('data-textarea');
            if (textarea) {
                textarea.value = prettyData;
                textarea.placeholder = 'Paste or edit your JSON data here...';
                textarea.classList.remove('modified');
            }

            originalData = prettyData;

            const snippet = document.querySelector('codapi-snippet');
            const queryDisplay = document.getElementById('query-display');

            const applyButton = document.getElementById('apply-button');
            if (applyButton) {
                applyButton.disabled = true;
            }

            if (dataset.queries && dataset.queries.length > 0) {
                showQuerySuggestions(dataset.queries);
                const firstQuery = dataset.queries[0].query;
                if (queryDisplay) queryDisplay.textContent = firstQuery;
                const editor = snippet?.querySelector('.snippet-code');
                if (editor) editor.textContent = firstQuery;
                originalQuery = firstQuery;
            } else {
                querySection.classList.add('hidden');
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
            }

            const datasetName = dataset.name || presetDatasets[datasetKey]?.name || datasetKey;
            const itemCount = dataset.itemCount || dataset.data?.length || 0;
            showDataStatus(`‚úì Loaded ${datasetName} (${itemCount} items)`, false);

            try {
                localStorage.setItem('selectedDataset', datasetKey);
            } catch (e) { }
        }

        function showQuerySuggestions(queries) {
            const querySection = document.getElementById('query-suggestions');
            const container = document.getElementById('query-buttons-container');

            container.innerHTML = '';

            queries.forEach((q, index) => {
                const button = document.createElement('button');
                button.className = 'query-pill';
                button.textContent = q.label;
                button.onclick = () => loadQuery(q.query);
                container.appendChild(button);
            });

            querySection.classList.remove('hidden');
        }

        function loadQuery(queryText) {
            const queryDisplay = document.getElementById('query-display');
            if (queryDisplay) {
                queryDisplay.textContent = queryText;
            }

            const snippet = document.querySelector('codapi-snippet');
            if (snippet) {
                const editor = snippet.querySelector('.snippet-code');
                if (editor) {
                    editor.textContent = queryText;
                }
            }

            originalQuery = queryText;

            showDataStatus('‚úì Query loaded - click "Run" to execute', false);

            const sqlSection = queryDisplay?.closest('section') || queryDisplay?.parentElement;
            if (sqlSection) {
                sqlSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function handleDataEdit() {
            const textarea = document.getElementById('data-textarea');
            const applyButton = document.getElementById('apply-button');

            const hasChanged = textarea.value.trim() !== originalData.trim();
            applyButton.disabled = !hasChanged;

            if (hasChanged) {
                textarea.classList.add('modified');
                resetShareLink();
            } else {
                textarea.classList.remove('modified');
            }
        }

        function applyDataChanges() {
            const textarea = document.getElementById('data-textarea');
            const applyButton = document.getElementById('apply-button');
            const data = textarea.value.trim();

            if (!data) {
                showDataStatus('Please enter JSON data', true);
                return;
            }

            try {
                const parsed = JSON.parse(data);
                const prettyData = JSON.stringify(parsed, null, 2);

                const scriptTag = document.getElementById('data.json');
                if (scriptTag) {
                    scriptTag.textContent = prettyData;
                }

                textarea.value = prettyData;
                originalData = prettyData;

                applyButton.disabled = true;
                textarea.classList.remove('modified');
                resetShareLink();

                showDataStatus('‚úì Data updated successfully', false);
            } catch (error) {
                showDataStatus(`Invalid JSON: ${error.message}`, true);
            }
        }

        function showDataStatus(message, isError = false) {
            const statusDiv = document.getElementById('data-status');
            statusDiv.textContent = message;
            statusDiv.className = 'animate-fade-in';
            statusDiv.style.cssText = `font-size: 0.8125rem; padding: 4px 12px; border-radius: var(--radius-md); background: ${isError ? 'var(--error-bg)' : 'var(--success-bg)'}; color: ${isError ? 'var(--error)' : 'var(--success)'}; border: 1px solid ${isError ? 'rgba(248,113,113,0.2)' : 'rgba(52,211,153,0.2)'};`;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function loadFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query');
            const data = urlParams.get('data');

            if (query || data) {
                document.getElementById('url-loaded-banner').classList.remove('hidden');

                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        const prettyData = JSON.stringify(parsedData, null, 2);

                        document.getElementById('data.json').textContent = prettyData;
                        document.getElementById('data-textarea').value = prettyData;
                        originalData = prettyData;
                        document.getElementById('dataset-picker').value = 'custom';
                    } catch (e) {
                        console.error('Invalid JSON in URL params:', e);
                    }
                }

                if (query) {
                    document.getElementById('query-display').textContent = query;
                }
            }
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'animate-fade-in';
            statusDiv.style.cssText = `margin-top: 12px; padding: 8px 16px; border-radius: var(--radius-md); font-size: 0.8125rem; background: ${isError ? 'var(--error-bg)' : 'var(--success-bg)'}; color: ${isError ? 'var(--error)' : 'var(--success)'}; border: 1px solid ${isError ? 'rgba(248,113,113,0.2)' : 'rgba(52,211,153,0.2)'};`;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function loadFromFile() {
            const fileInput = document.getElementById('data-file-picker');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('Please select a JSON file first', true);
                return;
            }

            if (!file.name.endsWith('.json')) {
                showStatus('Please select a valid JSON file (.json)', true);
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);

                    if (parsed._playgroundSession === true && parsed.data) {
                        const sessionData = typeof parsed.data === 'string' ? parsed.data : JSON.stringify(parsed.data, null, 2);
                        const prettyData = JSON.stringify(JSON.parse(sessionData), null, 2);

                        const scriptTag = document.getElementById('data.json');
                        if (scriptTag) {
                            scriptTag.textContent = prettyData;
                        }

                        const textarea = document.getElementById('data-textarea');
                        if (textarea) {
                            textarea.value = prettyData;
                            originalData = prettyData;
                        }

                        if (parsed.query) {
                            const queryDisplay = document.getElementById('query-display');
                            if (queryDisplay) {
                                queryDisplay.textContent = parsed.query;
                            }
                            const snippet = document.querySelector('codapi-snippet');
                            if (snippet) {
                                const editor = snippet.querySelector('.snippet-code');
                                if (editor) {
                                    editor.textContent = parsed.query;
                                }
                            }
                        }

                        currentDatasetKey = 'custom';
                        saveSession();

                        showStatus(`‚úì Imported session from ${file.name}`, false);
                    } else {
                        const prettyData = JSON.stringify(parsed, null, 2);

                        const scriptTag = document.getElementById('data.json');
                        if (scriptTag) {
                            scriptTag.textContent = prettyData;
                        }

                        const textarea = document.getElementById('data-textarea');
                        if (textarea) {
                            textarea.value = prettyData;
                            originalData = prettyData;
                        }

                        currentDatasetKey = 'custom';
                        saveSession();

                        showStatus(`‚úì Loaded ${file.name} successfully (${Math.round(file.size / 1024)} KB)`);
                    }

                } catch (error) {
                    showStatus(`Invalid JSON: ${error.message}`, true);
                }
            };

            reader.onerror = function () {
                showStatus('Error reading file', true);
            };

            reader.readAsText(file);
        }

        function exportSession() {
            const queryElement = document.querySelector('codapi-snippet').previousElementSibling;
            const query = queryElement ? queryElement.textContent.trim() : document.getElementById('query-display').textContent.trim();
            const data = document.getElementById('data.json').textContent.trim();

            if (!data) {
                showShareStatus('No data to export', true);
                return;
            }

            try {
                JSON.parse(data);
            } catch (e) {
                showShareStatus('Invalid JSON data: ' + e.message, true);
                return;
            }

            const session = {
                _playgroundSession: true,
                version: 1,
                exportedAt: new Date().toISOString(),
                datasetKey: currentDatasetKey,
                data: data,
                query: query || ''
            };

            const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cosmosdb-playground-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showShareStatus('‚úì Session exported successfully', false);
        }

        function importSession() {
            const fileInput = document.getElementById('import-file-picker');
            const file = fileInput.files[0];

            if (!file) return;

            if (!file.name.endsWith('.json')) {
                showShareStatus('Please select a valid JSON file (.json)', true);
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);

                    let dataToLoad, queryToLoad;

                    if (parsed._playgroundSession === true && parsed.data) {
                        dataToLoad = typeof parsed.data === 'string' ? parsed.data : JSON.stringify(parsed.data, null, 2);
                        queryToLoad = parsed.query || null;
                    } else {
                        dataToLoad = JSON.stringify(parsed, null, 2);
                        queryToLoad = null;
                    }

                    const prettyData = JSON.stringify(JSON.parse(dataToLoad), null, 2);

                    const scriptTag = document.getElementById('data.json');
                    if (scriptTag) {
                        scriptTag.textContent = prettyData;
                    }

                    const textarea = document.getElementById('data-textarea');
                    if (textarea) {
                        textarea.value = prettyData;
                        originalData = prettyData;
                    }

                    if (queryToLoad) {
                        const queryDisplay = document.getElementById('query-display');
                        if (queryDisplay) {
                            queryDisplay.textContent = queryToLoad;
                        }
                        const snippet = document.querySelector('codapi-snippet');
                        if (snippet) {
                            const editor = snippet.querySelector('.snippet-code');
                            if (editor) {
                                editor.textContent = queryToLoad;
                            }
                        }
                    }

                    currentDatasetKey = 'custom';
                    document.getElementById('dataset-picker').value = 'custom';
                    document.getElementById('query-suggestions')?.classList.add('hidden');
                    saveSession();

                    const isSessionFile = parsed._playgroundSession === true;
                    showShareStatus(`‚úì ${isSessionFile ? 'Session imported' : 'Data loaded'} from ${file.name}`, false);

                } catch (error) {
                    showShareStatus(`Invalid JSON: ${error.message}`, true);
                }

                fileInput.value = '';
            };

            reader.onerror = function () {
                showShareStatus('Error reading file', true);
                fileInput.value = '';
            };

            reader.readAsText(file);
        }

        function generateShareLink() {
            const queryElement = document.querySelector('codapi-snippet').previousElementSibling;
            const query = queryElement ? queryElement.textContent.trim() : document.getElementById('query-display').textContent.trim();
            const data = document.getElementById('data.json').textContent.trim();

            if (!query) {
                showShareStatus('No query to share', true);
                return;
            }

            if (!data) {
                showShareStatus('No data to share', true);
                return;
            }

            try {
                JSON.parse(data);
            } catch (e) {
                showShareStatus('Invalid JSON data: ' + e.message, true);
                return;
            }

            let baseUrl;
            if (window.location.protocol === 'file:') {
                const currentPath = window.location.pathname;
                const runPath = currentPath.replace('/playground.html', '/run.html');
                baseUrl = window.location.protocol + '//' + runPath;
            } else {
                baseUrl = window.location.origin + '/run.html';
            }

            const currentData = JSON.parse(data);
            const dataUnchanged = currentDatasetKey !== 'custom' &&
                originalPresetData &&
                JSON.stringify(currentData) === JSON.stringify(originalPresetData);

            if (dataUnchanged) {
                const encodedQuery = btoa(query);
                const urlSafeQuery = encodeURIComponent(encodedQuery);
                currentShareUrl = `${baseUrl}?dataset=${currentDatasetKey}&q=${urlSafeQuery}`;
                showShareStatus('‚úì Share link generated', false);
            } else {
                const payload = JSON.stringify({ query, data });
                const compressed = pako.gzip(payload);
                const base64 = btoa(String.fromCharCode.apply(null, compressed));
                const urlSafe = encodeURIComponent(base64);
                currentShareUrl = `${baseUrl}#c=${urlSafe}`;
                showShareStatus(`‚úì Share link generated`, false);
            }

            document.getElementById('share-buttons').classList.remove('hidden');
        }

        function copyShareLink() {
            if (!currentShareUrl) return;

            navigator.clipboard.writeText(currentShareUrl).then(() => {
                showShareStatus('‚úì Link copied to clipboard!', false);
            }).catch(err => {
                showShareStatus('Failed to copy: ' + err, true);
            });
        }

        function openShareLink() {
            if (currentShareUrl) {
                window.open(currentShareUrl, '_blank');
            }
        }

        function showShareStatus(message, isError = false) {
            const statusDiv = document.getElementById('share-status');
            statusDiv.textContent = message;
            statusDiv.className = 'animate-fade-in';
            statusDiv.style.cssText = `margin-top: 12px; font-size: 0.8125rem; padding: 4px 12px; border-radius: var(--radius-md); background: ${isError ? 'var(--error-bg)' : 'var(--success-bg)'}; color: ${isError ? 'var(--error)' : 'var(--success)'}; border: 1px solid ${isError ? 'rgba(248,113,113,0.2)' : 'rgba(52,211,153,0.2)'};`;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const code = codeElement.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const button = event.target.closest('.copy-code-button');
                const originalHTML = button.innerHTML;

                button.innerHTML = '<i data-lucide="check"></i> Copied!';
                button.classList.add('copied');

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }

        // Enable drag & drop for custom file upload
        const uploadSection = document.getElementById('file-upload-section');
        if (uploadSection) {
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file) {
                    const fileInput = document.getElementById('data-file-picker');
                    fileInput.files = e.dataTransfer.files;
                    loadFromFile();
                }
            });
        }

        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        function initializePlayground() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlParams = urlParams.get('query') || urlParams.get('data');

            if (hasUrlParams) {
                loadFromUrlParams();
                clearSession();
                originalData = document.getElementById('data-textarea').value.trim();
                setupAutoSave();
                return;
            }

            const savedSession = loadSession();
            if (savedSession && savedSession.data) {
                showSessionRestoreBanner(savedSession);
            }

            try {
                const savedDataset = localStorage.getItem('selectedDataset');
                if (savedDataset && presetDatasets[savedDataset]) {
                    document.getElementById('dataset-picker').value = savedDataset;
                    loadPresetDataset();
                }
            } catch (e) { }

            originalData = document.getElementById('data-textarea').value.trim();

            if (!originalQuery) {
                const snippet = document.querySelector('codapi-snippet');
                const queryDisplay = document.getElementById('query-display');
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
            }

            setupAutoSave();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePlayground);
        } else {
            initializePlayground();
        }
    </script>

</body>

</html>
