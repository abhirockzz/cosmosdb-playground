<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Cosmos DB Playground</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: {
                            DEFAULT: '#0078d4',
                            hover: '#106ebe',
                            light: '#deecf9'
                        }
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Consolas', 'Courier New', 'monospace']
                    }
                }
            }
        }
    </script>

    <!-- Codapi Widget -->
    <script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.js"></script>
    <script src="https://unpkg.com/@antonz/codapi@0.20.0/dist/settings.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@antonz/codapi@0.20.0/dist/snippet.css" />

    <!-- Pako for compression -->
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

    <!-- Prism.js for SQL syntax highlighting -->
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.29.0/themes/prism.min.css" />
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-sql.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Minimal custom styles */
        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease;
        }

        /* Custom scrollbar for textareas */
        .data-textarea::-webkit-scrollbar {
            width: 8px;
        }

        .data-textarea::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .data-textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .data-textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Modified indicator for textarea */
        .data-textarea.modified {
            border-left: 3px solid #f59e0b;
            padding-left: 13px;
        }

        /* Drag over state for file upload */
        .file-upload-section.drag-over {
            border-color: #0078d4 !important;
            background-color: rgba(0, 120, 212, 0.05) !important;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 antialiased">
    <script>
        // Auto-detect environment and write codapi-settings element with correct URL
        const isLocal = window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.protocol === 'file:';

        const codapiUrl = isLocal
            ? 'http://localhost/v1'
            : `${window.location.protocol}//${window.location.host}/v1`;

        document.write('<codapi-settings url="' + codapiUrl + '"></codapi-settings>');
    </script>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Top Navigation -->
        <nav class="flex justify-end items-center mb-8">
            <a href="https://github.com/abhirockzz/cosmosdb-playground" target="_blank"
                class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-700 hover:border-slate-300 hover:shadow-sm transition-all">
                <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                    </path>
                </svg>
                Star on GitHub
            </a>
        </nav>

        <!-- Header -->
        <header class="text-center mb-10">
            <div class="flex items-center justify-center gap-3 mb-3">
                <img src="https://raw.githubusercontent.com/AzureCosmosDB/gallery/main/static/img/cosmos.png"
                    alt="Azure Cosmos DB" class="h-10 w-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight">
                    Azure Cosmos DB Playground
                </h1>
            </div>
            <p class="text-sm text-slate-500">
                Powered by
                <a href="https://learn.microsoft.com/azure/cosmos-db/emulator-linux" target="_blank"
                    class="text-accent hover:underline">Azure Cosmos DB vNext Emulator</a>
                and
                <a href="https://codapi.org/" target="_blank" class="text-accent hover:underline">Codapi</a>
            </p>
        </header>

        <!-- URL Loaded Banner -->
        <div id="url-loaded-banner" class="hidden bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
            <p class="text-sm text-amber-800">
                ‚ú® Code loaded from shared link. You can edit and experiment freely!
            </p>
        </div>

        <!-- Session Restore Banner -->
        <div id="session-restore-banner" class="hidden bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <p class="text-sm font-medium text-blue-800 mb-1">
                        üìù Welcome back! You have a previous session.
                    </p>
                    <p id="session-restore-details" class="text-xs text-blue-600"></p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="restoreSession()"
                        class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition-colors">
                        Restore
                    </button>
                    <button onclick="dismissSessionRestore()"
                        class="px-3 py-1.5 bg-white border border-blue-200 text-blue-700 text-xs font-medium rounded-lg hover:bg-blue-50 transition-colors">
                        Start Fresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Intro Text -->
        <p class="text-slate-600 mb-8 text-center max-w-2xl mx-auto">
            Experiment with
            <a href="https://learn.microsoft.com/en-us/cosmos-db/query/overview" target="_blank"
                class="text-accent hover:underline font-medium">Cosmos DB SQL queries</a>
            interactively. Choose a preset dataset or load your own data.
        </p>

        <!-- Main Content Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">

            <!-- Dataset Section -->
            <div class="p-6 border-b border-slate-100">
                <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="text-xl">üìä</span> Sample Data
                </h2>

                <!-- Dataset Selector -->
                <div class="mb-4">
                    <label for="dataset-picker" class="block text-sm font-medium text-slate-700 mb-2">
                        Choose a Dataset
                    </label>
                    <select id="dataset-picker" onchange="loadPresetDataset()"
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent transition-all cursor-pointer appearance-none"
                        style="background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%2364748b' d='M6 8L0 2h12z'/%3E%3C/svg%3E&quot;); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px;">
                        <option value="simple">Simple Demo (3 items)</option>
                        <option value="products">E-commerce Products (10 items)</option>
                        <option value="iot">IoT Device Telemetry (45 items)</option>
                        <option value="movies">Movie Database (50 items)</option>
                        <option value="embed">Blog Posts - Embedded Data Model (8 items)</option>
                        <option value="reference">Order System - Referenced Data Model (17 items)</option>
                        <option value="hybrid">Conference System - Hybrid Data Model (10 items)</option>
                        <option value="custom">Custom Data</option>
                    </select>
                </div>

                <!-- Dataset Info -->
                <div id="dataset-info"
                    class="text-sm text-slate-500 bg-slate-50 rounded-lg p-3 border border-slate-100">
                    Basic user records with name, city, and age. Perfect for learning SQL query basics.
                </div>
            </div>

            <!-- Query Suggestions -->
            <div id="query-suggestions"
                class="hidden p-6 border-b border-slate-100 bg-gradient-to-r from-accent/5 to-transparent">
                <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                    <span>üí°</span> Try these queries:
                </h4>
                <div id="query-buttons-container" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Partition Key Info -->
            <details class="border-b border-slate-100">
                <summary
                    class="px-6 py-4 cursor-pointer text-sm font-medium text-slate-600 hover:text-accent transition-colors select-none">
                    ‚ÑπÔ∏è About Partition Keys in this Playground
                </summary>
                <div class="px-6 pb-4 text-sm text-slate-500 space-y-2">
                    <p>
                        This playground uses <code
                            class="bg-slate-100 px-1.5 py-0.5 rounded text-xs font-mono">/id</code> as
                        the partition key for all queries. This works with any JSON data since
                        the <code class="bg-slate-100 px-1.5 py-0.5 rounded text-xs font-mono">id</code> field is
                        auto-generated if missing.
                    </p>
                    <p>
                        <strong class="text-slate-700">In production Cosmos DB:</strong> Choose partition keys based on
                        your
                        query patterns (e.g., <code
                            class="bg-slate-100 px-1.5 py-0.5 rounded text-xs font-mono">/tenantId</code>,
                        <code class="bg-slate-100 px-1.5 py-0.5 rounded text-xs font-mono">/userId</code>).
                        <a href="https://learn.microsoft.com/azure/cosmos-db/partitioning-overview" target="_blank"
                            class="text-accent hover:underline">
                            Learn more ‚Üí
                        </a>
                    </p>
                </div>
            </details>

            <!-- File Upload Section (hidden by default) -->
            <div id="file-upload-section" class="hidden p-6 border-b border-slate-100 file-upload-section">
                <div
                    class="border-2 border-dashed border-slate-200 rounded-lg p-6 text-center hover:border-slate-300 transition-colors">
                    <input type="file" id="data-file-picker" accept=".json,application/json"
                        class="text-sm text-slate-500 mb-3">
                    <button id="load-file-btn" onclick="loadFromFile()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-accent text-white text-sm font-medium rounded-lg hover:bg-accent-hover transition-colors">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Load from File
                    </button>
                </div>
                <div id="status-message" class="hidden mt-3 px-4 py-2 rounded-lg text-sm"></div>
            </div>

            <!-- Hidden script tag for codapi to reference -->
            <script id="data.json" type="text/plain">
[
  {"id": "1", "name": "Alice", "city": "New York", "age": 30},
  {"id": "2", "name": "Bob", "city": "London", "age": 25},
  {"id": "3", "name": "Charlie", "city": "London", "age": 35}
]
            </script>

            <!-- Data Editor -->
            <div class="border-b border-slate-100">
                <textarea id="data-textarea"
                    class="data-textarea w-full min-h-[200px] p-4 font-mono text-sm text-slate-700 bg-white border-0 focus:outline-none focus:ring-0 resize-y"
                    placeholder="Paste or edit your JSON data here..." oninput="handleDataEdit()">[
  {"id": "1", "name": "Alice", "city": "New York", "age": 30},
  {"id": "2", "name": "Bob", "city": "London", "age": 25},
  {"id": "3", "name": "Charlie", "city": "London", "age": 35}
]</textarea>
                <div class="px-4 py-3 bg-slate-50 border-t border-slate-100 flex items-center gap-3">
                    <button id="apply-button" onclick="applyDataChanges()" disabled
                        class="inline-flex items-center gap-2 px-4 py-2 bg-accent text-white text-sm font-medium rounded-lg hover:bg-accent-hover disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Apply Changes
                    </button>
                    <div id="data-status" class="hidden text-sm px-3 py-1.5 rounded-lg"></div>
                </div>
            </div>

            <!-- SQL Query Section -->
            <div class="p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="text-xl">‚ö°</span> SQL Query
                </h2>

                <pre
                    class="bg-slate-50 border border-slate-200 rounded-lg p-4 overflow-x-auto mb-4"><code id="query-display" class="language-sql text-sm">SELECT * FROM c WHERE c.city = 'London'</code></pre>

                <!-- Codapi Widget -->
                <codapi-snippet sandbox="cosmosdb" command="run" editor="basic" files="#data.json">
                </codapi-snippet>
            </div>

            <!-- Share Section -->
            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <h3 class="text-base font-semibold text-slate-900 mb-2 flex items-center gap-2">
                    <span>üîó</span> Share with others
                </h3>
                <p class="text-sm text-slate-500 mb-4">
                    Generate a shareable link. Perfect for blog posts, tutorials, and more!
                </p>
                <!-- Share row -->
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <button onclick="generateShareLink()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-accent text-white text-sm font-medium rounded-lg hover:bg-accent-hover transition-colors">
                        <i data-lucide="link" class="w-4 h-4"></i>
                        Generate Link
                    </button>
                    <div id="share-buttons" class="hidden flex items-center gap-2">
                        <button onclick="copyShareLink()"
                            class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            Copy Link
                        </button>
                        <button onclick="openShareLink()"
                            class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                            Open Link
                        </button>
                    </div>
                </div>
                <!-- Export/Import row -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Export/Import buttons hidden: feature temporarily unavailable -->
                    <!--
                    <button onclick="exportSession()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export to File
                    </button>
                    <button onclick="document.getElementById('import-file-picker').click()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Import from File
                    </button>
                    <input type="file" id="import-file-picker" accept=".json,application/json" class="hidden"
                        onchange="importSession()">
                    -->
                </div>
                <div id="share-status" class="hidden mt-3 text-sm px-3 py-1.5 rounded-lg"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-slate-200 text-center text-sm text-slate-400">
            <p>Built with ‚ù§Ô∏è for the Azure Cosmos DB community</p>
        </footer>
    </div>

    <script>
        // Preset Datasets (metadata only - data loaded from external JSON files)
        const presetDatasets = {
            simple: {
                description: "Basic user records with name, city, and age. Perfect for learning SQL query basics."
            },
            products: {
                description: "Product catalog with nested objects, arrays, and complex queries. Includes inventory, specs, and reviews."
            },
            iot: {
                description: "Time-series data from IoT devices including temperature, humidity, and status metrics."
            },
            movies: {
                description: "Classic and contemporary films with genres, directors, actors, ratings, and awards."
            },
            embed: {
                description: "Demonstrates embedded data modeling pattern where related data is stored within a single document. Blog posts with embedded author details, comments array, and tags. This pattern is ideal when data is always accessed together, reducing the need for joins and improving query performance. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#embed-data"
            },
            reference: {
                description: "Demonstrates referenced data modeling pattern where related data is stored in separate documents and linked via IDs. Orders reference customers and products rather than embedding them. This pattern is ideal when data changes frequently, is accessed independently, or could grow unbounded. Avoids data duplication and enables independent updates. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#reference-data"
            },
            hybrid: {
                description: "Demonstrates hybrid data modeling pattern combining embedded and referenced data based on access patterns. Conferences embed session details (always accessed together) but reference speaker documents (shared across sessions, updated independently). This approach balances the benefits of both patterns for optimal performance. Learn more: https://learn.microsoft.com/azure/cosmos-db/modeling-data#hybrid-data-models"
            },
            custom: {
                description: "Experiment with your data."
            }
        };

        let currentShareUrl = '';
        let originalData = '';
        let originalQuery = ''; // Query state when dataset was loaded
        let lastSelectedPreset = 'simple';
        let currentDatasetKey = 'simple';
        let originalPresetData = null;
        let originalPresetQueries = []; // Array of valid queries for current preset
        let pendingSessionRestore = null;

        // Session storage constants
        const SESSION_STORAGE_KEY = 'cosmosdb-playground-session';
        const SESSION_TTL_DAYS = 7;

        // Reset share link when content changes (prevents sharing stale links)
        function resetShareLink() {
            currentShareUrl = '';
            document.getElementById('share-buttons').classList.add('hidden');
        }

        // Session management functions
        function saveSession() {
            try {
                const textarea = document.getElementById('data-textarea');
                const queryDisplay = document.getElementById('query-display');
                const snippet = document.querySelector('codapi-snippet');

                const currentData = textarea ? textarea.value.trim() : '';
                const currentQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';

                // Only save if there's meaningful custom data (not just default preset unchanged)
                const isDataModified = currentDatasetKey === 'custom' ||
                    (originalPresetData && currentData !== JSON.stringify(originalPresetData, null, 2));

                // Check if query has changed from original state OR is a preset query (user clicked suggestion)
                const isQueryUnchanged = currentQuery === originalQuery ||
                    (originalPresetQueries.length > 0 && originalPresetQueries.some(q => q === currentQuery));

                if (!isDataModified && isQueryUnchanged) {
                    // Unmodified preset state, no need to save
                    clearSession();
                    return;
                }

                const session = {
                    datasetKey: currentDatasetKey,
                    data: currentData,
                    query: currentQuery,
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (SESSION_TTL_DAYS * 24 * 60 * 60 * 1000)
                };

                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
            } catch (e) {
                // Silently fail - quota exceeded or other localStorage issues
                if (e.name === 'QuotaExceededError') {
                    console.warn('Session auto-save failed: localStorage quota exceeded');
                }
            }
        }

        function loadSession() {
            try {
                const stored = localStorage.getItem(SESSION_STORAGE_KEY);
                if (!stored) return null;

                const session = JSON.parse(stored);

                // Check if session has expired
                if (session.expiresAt && Date.now() > session.expiresAt) {
                    clearSession();
                    return null;
                }

                return session;
            } catch (e) {
                clearSession();
                return null;
            }
        }

        function clearSession() {
            try {
                localStorage.removeItem(SESSION_STORAGE_KEY);
            } catch (e) { }
        }

        function showSessionRestoreBanner(session) {
            const banner = document.getElementById('session-restore-banner');
            const details = document.getElementById('session-restore-details');

            if (!banner || !session) return;

            // Calculate time ago
            const minutesAgo = Math.floor((Date.now() - session.timestamp) / (1000 * 60));
            let timeAgo;
            if (minutesAgo < 1) {
                timeAgo = 'just now';
            } else if (minutesAgo < 60) {
                timeAgo = `${minutesAgo} minute${minutesAgo === 1 ? '' : 's'} ago`;
            } else if (minutesAgo < 1440) {
                const hours = Math.floor(minutesAgo / 60);
                timeAgo = `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else {
                const days = Math.floor(minutesAgo / 1440);
                timeAgo = `${days} day${days === 1 ? '' : 's'} ago`;
            }

            const datasetLabel = session.datasetKey === 'custom' ? 'custom data' : `${session.datasetKey} dataset (modified)`;
            details.textContent = `Last saved ${timeAgo} with ${datasetLabel}`;

            pendingSessionRestore = session;
            banner.classList.remove('hidden');
        }

        function restoreSession() {
            if (!pendingSessionRestore) return;

            const session = pendingSessionRestore;
            const textarea = document.getElementById('data-textarea');
            const scriptTag = document.getElementById('data.json');
            const queryDisplay = document.getElementById('query-display');
            const snippet = document.querySelector('codapi-snippet');
            const datasetPicker = document.getElementById('dataset-picker');

            // Restore data
            if (session.data) {
                if (textarea) textarea.value = session.data;
                if (scriptTag) scriptTag.textContent = session.data;
                originalData = session.data;
            }

            // Restore query
            if (session.query) {
                if (queryDisplay) queryDisplay.textContent = session.query;
                if (snippet) {
                    const editor = snippet.querySelector('.snippet-code');
                    if (editor) editor.textContent = session.query;
                }
            }

            // Restore dataset picker
            if (session.datasetKey) {
                currentDatasetKey = session.datasetKey;
                if (datasetPicker) {
                    datasetPicker.value = session.datasetKey;
                    // Hide query suggestions for custom data (no presets)
                    if (session.datasetKey === 'custom') {
                        document.getElementById('query-suggestions')?.classList.add('hidden');
                    }
                }
            }

            dismissSessionRestore();
            showDataStatus('‚úì Previous session restored', false);
        }

        function dismissSessionRestore() {
            const banner = document.getElementById('session-restore-banner');
            if (banner) banner.classList.add('hidden');
            pendingSessionRestore = null;
            // Clear the saved session when user chooses "Start Fresh"
            if (!arguments[0]) { // Called from "Start Fresh" button
                // Don't clear here - only clear if explicitly starting fresh
            }
        }

        function setupAutoSave() {
            // Debounced save function
            let saveTimeout = null;
            const debouncedSave = () => {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveSession, 2000); // Save 2 seconds after last change
            };

            // Save on data textarea changes
            const textarea = document.getElementById('data-textarea');
            if (textarea) {
                textarea.addEventListener('input', debouncedSave);
            }

            // Save on apply changes
            const originalApplyDataChanges = window.applyDataChanges;
            window.applyDataChanges = function () {
                originalApplyDataChanges.apply(this, arguments);
                saveSession();
            };

            // Save when query changes (observe codapi snippet)
            const snippet = document.querySelector('codapi-snippet');
            if (snippet) {
                const observer = new MutationObserver(() => {
                    debouncedSave();
                    resetShareLink(); // Hide share buttons when query is modified
                });
                observer.observe(snippet, { childList: true, subtree: true, characterData: true });

                // Also listen for input events on the editor (MutationObserver doesn't catch typing)
                snippet.addEventListener('input', () => {
                    debouncedSave();
                    resetShareLink();
                }, true); // Use capture to catch events from child elements
            }

            // Save on page unload as a safety net
            window.addEventListener('beforeunload', saveSession);
        }

        // Load preset dataset (from external JSON files)
        async function loadPresetDataset() {
            const selector = document.getElementById('dataset-picker');
            const datasetKey = selector.value;
            const fileSection = document.getElementById('file-upload-section');
            const querySection = document.getElementById('query-suggestions');

            if (datasetKey === 'custom') {
                const textarea = document.getElementById('data-textarea');
                const currentData = textarea.value.trim();
                const hasUnsavedChanges = currentData && currentData !== originalData.trim();

                if (hasUnsavedChanges) {
                    const confirmed = confirm('This will clear your current data. Continue?');
                    if (!confirmed) {
                        selector.value = lastSelectedPreset;
                        loadPresetDataset();
                        return;
                    }
                }

                fileSection.classList.remove('hidden');
                querySection.classList.add('hidden');
                textarea.value = '';
                textarea.placeholder = 'Paste your JSON data here...\n\nOr use the file upload option above.';
                textarea.classList.remove('modified');
                originalData = '';
                currentDatasetKey = 'custom';
                originalPresetData = null;
                originalPresetQueries = []; // No preset queries for custom data
                // Update the dataset description for custom data
                const infoDiv = document.getElementById('dataset-info');
                if (infoDiv) infoDiv.innerHTML = presetDatasets.custom.description;
                // Capture current query state for custom data
                const snippet = document.querySelector('codapi-snippet');
                const queryDisplay = document.getElementById('query-display');
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
                const applyButton = document.getElementById('apply-button');
                applyButton.disabled = true;
                const scriptTag = document.getElementById('data.json');
                if (scriptTag) scriptTag.textContent = '';
                showDataStatus('üìã Upload a JSON file or paste your data below', false);
                return;
            } else {
                fileSection.classList.add('hidden');
                lastSelectedPreset = datasetKey;
            }

            let dataset;
            try {
                showDataStatus('Loading dataset...', false);
                const response = await fetch(`datasets/${datasetKey}.json`);
                if (!response.ok) throw new Error('Failed to load dataset file');
                dataset = await response.json();
            } catch (error) {
                console.warn(`Failed to load external dataset file for ${datasetKey}:`, error);
                showDataStatus('‚ùå Failed to load dataset', true);
                return;
            }

            const infoDiv = document.getElementById('dataset-info');
            infoDiv.innerHTML = dataset.description;

            currentDatasetKey = datasetKey;
            originalPresetData = dataset.data;
            // Store the preset's default queries for session save comparison
            originalPresetQueries = dataset.queries ? dataset.queries.map(q => q.query) : [];

            const prettyData = JSON.stringify(dataset.data, null, 2);

            const scriptTag = document.getElementById('data.json');
            if (scriptTag) {
                scriptTag.textContent = prettyData;
            }

            const textarea = document.getElementById('data-textarea');
            if (textarea) {
                textarea.value = prettyData;
                textarea.placeholder = 'Paste or edit your JSON data here...';
                textarea.classList.remove('modified');
            }

            originalData = prettyData;

            // Capture current query state when loading preset
            const snippet = document.querySelector('codapi-snippet');
            const queryDisplay = document.getElementById('query-display');

            const applyButton = document.getElementById('apply-button');
            if (applyButton) {
                applyButton.disabled = true;
            }

            if (dataset.queries && dataset.queries.length > 0) {
                showQuerySuggestions(dataset.queries);
                // Auto-load first query to match the dataset (no scroll)
                const firstQuery = dataset.queries[0].query;
                if (queryDisplay) queryDisplay.textContent = firstQuery;
                const editor = snippet?.querySelector('.snippet-code');
                if (editor) editor.textContent = firstQuery;
                originalQuery = firstQuery;
            } else {
                querySection.classList.add('hidden');
                // No preset queries, capture current query state
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
            }

            const datasetName = dataset.name || presetDatasets[datasetKey]?.name || datasetKey;
            const itemCount = dataset.itemCount || dataset.data?.length || 0;
            showDataStatus(`‚úì Loaded ${datasetName} (${itemCount} items)`, false);

            try {
                localStorage.setItem('selectedDataset', datasetKey);
            } catch (e) { }
        }

        function showQuerySuggestions(queries) {
            const querySection = document.getElementById('query-suggestions');
            const container = document.getElementById('query-buttons-container');

            container.innerHTML = '';

            queries.forEach((q, index) => {
                const button = document.createElement('button');
                button.className = 'px-3 py-1.5 bg-white border border-slate-200 rounded-full text-sm text-accent font-medium hover:bg-accent hover:text-white hover:border-accent transition-all cursor-pointer';
                button.textContent = q.label;
                button.onclick = () => loadQuery(q.query);
                container.appendChild(button);
            });

            querySection.classList.remove('hidden');
        }

        function loadQuery(queryText) {
            const queryDisplay = document.getElementById('query-display');
            if (queryDisplay) {
                queryDisplay.textContent = queryText;
            }

            const snippet = document.querySelector('codapi-snippet');
            if (snippet) {
                const editor = snippet.querySelector('.snippet-code');
                if (editor) {
                    editor.textContent = queryText;
                }
            }

            // Update originalQuery since user selected a preset query (not a custom edit)
            originalQuery = queryText;

            showDataStatus('‚úì Query loaded - click "Run" to execute', false);

            const sqlSection = queryDisplay?.closest('section') || queryDisplay?.parentElement;
            if (sqlSection) {
                sqlSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function handleDataEdit() {
            const textarea = document.getElementById('data-textarea');
            const applyButton = document.getElementById('apply-button');

            const hasChanged = textarea.value.trim() !== originalData.trim();
            applyButton.disabled = !hasChanged;

            if (hasChanged) {
                textarea.classList.add('modified');
                resetShareLink(); // Hide share buttons when data is modified
            } else {
                textarea.classList.remove('modified');
            }
        }

        function applyDataChanges() {
            const textarea = document.getElementById('data-textarea');
            const applyButton = document.getElementById('apply-button');
            const data = textarea.value.trim();

            if (!data) {
                showDataStatus('Please enter JSON data', true);
                return;
            }

            try {
                const parsed = JSON.parse(data);
                const prettyData = JSON.stringify(parsed, null, 2);

                const scriptTag = document.getElementById('data.json');
                if (scriptTag) {
                    scriptTag.textContent = prettyData;
                }

                textarea.value = prettyData;
                originalData = prettyData;

                applyButton.disabled = true;
                textarea.classList.remove('modified');
                resetShareLink(); // Hide share buttons since data changed

                showDataStatus('‚úì Data updated successfully', false);
            } catch (error) {
                showDataStatus(`Invalid JSON: ${error.message}`, true);
            }
        }

        function showDataStatus(message, isError = false) {
            const statusDiv = document.getElementById('data-status');
            statusDiv.textContent = message;
            statusDiv.className = 'text-sm px-3 py-1.5 rounded-lg animate-fade-in ' +
                (isError ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-green-50 text-green-600 border border-green-200');
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function loadFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query');
            const data = urlParams.get('data');

            if (query || data) {
                document.getElementById('url-loaded-banner').classList.remove('hidden');

                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        const prettyData = JSON.stringify(parsedData, null, 2);

                        document.getElementById('data.json').textContent = prettyData;
                        document.getElementById('data-textarea').value = prettyData;
                        originalData = prettyData;
                        document.getElementById('dataset-picker').value = 'custom';
                    } catch (e) {
                        console.error('Invalid JSON in URL params:', e);
                    }
                }

                if (query) {
                    document.getElementById('query-display').textContent = query;
                }
            }
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm animate-fade-in ' +
                (isError ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-green-50 text-green-600 border border-green-200');
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function loadFromFile() {
            const fileInput = document.getElementById('data-file-picker');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('Please select a JSON file first', true);
                return;
            }

            if (!file.name.endsWith('.json')) {
                showStatus('Please select a valid JSON file (.json)', true);
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);

                    // Check if this is a session export file
                    if (parsed._playgroundSession === true && parsed.data) {
                        // Session file - extract data and query
                        const sessionData = typeof parsed.data === 'string' ? parsed.data : JSON.stringify(parsed.data, null, 2);
                        const prettyData = JSON.stringify(JSON.parse(sessionData), null, 2);

                        const scriptTag = document.getElementById('data.json');
                        if (scriptTag) {
                            scriptTag.textContent = prettyData;
                        }

                        const textarea = document.getElementById('data-textarea');
                        if (textarea) {
                            textarea.value = prettyData;
                            originalData = prettyData;
                        }

                        // Restore query if present
                        if (parsed.query) {
                            const queryDisplay = document.getElementById('query-display');
                            if (queryDisplay) {
                                queryDisplay.textContent = parsed.query;
                            }
                            const snippet = document.querySelector('codapi-snippet');
                            if (snippet) {
                                const editor = snippet.querySelector('.snippet-code');
                                if (editor) {
                                    editor.textContent = parsed.query;
                                }
                            }
                        }

                        currentDatasetKey = 'custom';
                        saveSession();

                        showStatus(`‚úì Imported session from ${file.name}`, false);
                    } else {
                        // Raw data file - existing behavior
                        const prettyData = JSON.stringify(parsed, null, 2);

                        const scriptTag = document.getElementById('data.json');
                        if (scriptTag) {
                            scriptTag.textContent = prettyData;
                        }

                        const textarea = document.getElementById('data-textarea');
                        if (textarea) {
                            textarea.value = prettyData;
                            originalData = prettyData;
                        }

                        // Update dataset key to custom and save session
                        currentDatasetKey = 'custom';
                        saveSession();

                        showStatus(`‚úì Loaded ${file.name} successfully (${Math.round(file.size / 1024)} KB)`);
                    }

                } catch (error) {
                    showStatus(`Invalid JSON: ${error.message}`, true);
                }
            };

            reader.onerror = function () {
                showStatus('Error reading file', true);
            };

            reader.readAsText(file);
        }

        function exportSession() {
            const queryElement = document.querySelector('codapi-snippet').previousElementSibling;
            const query = queryElement ? queryElement.textContent.trim() : document.getElementById('query-display').textContent.trim();
            const data = document.getElementById('data.json').textContent.trim();

            if (!data) {
                showShareStatus('No data to export', true);
                return;
            }

            try {
                JSON.parse(data);
            } catch (e) {
                showShareStatus('Invalid JSON data: ' + e.message, true);
                return;
            }

            const session = {
                _playgroundSession: true,
                version: 1,
                exportedAt: new Date().toISOString(),
                datasetKey: currentDatasetKey,
                data: data,
                query: query || ''
            };

            const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cosmosdb-playground-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showShareStatus('‚úì Session exported successfully', false);
        }

        function importSession() {
            const fileInput = document.getElementById('import-file-picker');
            const file = fileInput.files[0];

            if (!file) return;

            if (!file.name.endsWith('.json')) {
                showShareStatus('Please select a valid JSON file (.json)', true);
                fileInput.value = ''; // Reset for next selection
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);

                    let dataToLoad, queryToLoad;

                    // Check if this is a session export file
                    if (parsed._playgroundSession === true && parsed.data) {
                        // Session file - extract data and query
                        dataToLoad = typeof parsed.data === 'string' ? parsed.data : JSON.stringify(parsed.data, null, 2);
                        queryToLoad = parsed.query || null;
                    } else {
                        // Raw data file
                        dataToLoad = JSON.stringify(parsed, null, 2);
                        queryToLoad = null;
                    }

                    const prettyData = JSON.stringify(JSON.parse(dataToLoad), null, 2);

                    const scriptTag = document.getElementById('data.json');
                    if (scriptTag) {
                        scriptTag.textContent = prettyData;
                    }

                    const textarea = document.getElementById('data-textarea');
                    if (textarea) {
                        textarea.value = prettyData;
                        originalData = prettyData;
                    }

                    // Restore query if present
                    if (queryToLoad) {
                        const queryDisplay = document.getElementById('query-display');
                        if (queryDisplay) {
                            queryDisplay.textContent = queryToLoad;
                        }
                        const snippet = document.querySelector('codapi-snippet');
                        if (snippet) {
                            const editor = snippet.querySelector('.snippet-code');
                            if (editor) {
                                editor.textContent = queryToLoad;
                            }
                        }
                    }

                    // Update UI state
                    currentDatasetKey = 'custom';
                    document.getElementById('dataset-picker').value = 'custom';
                    // Don't show file-upload-section - import was done via Import button
                    document.getElementById('query-suggestions')?.classList.add('hidden');
                    saveSession();

                    const isSessionFile = parsed._playgroundSession === true;
                    showShareStatus(`‚úì ${isSessionFile ? 'Session imported' : 'Data loaded'} from ${file.name}`, false);

                } catch (error) {
                    showShareStatus(`Invalid JSON: ${error.message}`, true);
                }

                fileInput.value = ''; // Reset for next selection
            };

            reader.onerror = function () {
                showShareStatus('Error reading file', true);
                fileInput.value = '';
            };

            reader.readAsText(file);
        }

        function generateShareLink() {
            const queryElement = document.querySelector('codapi-snippet').previousElementSibling;
            const query = queryElement ? queryElement.textContent.trim() : document.getElementById('query-display').textContent.trim();
            const data = document.getElementById('data.json').textContent.trim();

            if (!query) {
                showShareStatus('No query to share', true);
                return;
            }

            if (!data) {
                showShareStatus('No data to share', true);
                return;
            }

            try {
                JSON.parse(data);
            } catch (e) {
                showShareStatus('Invalid JSON data: ' + e.message, true);
                return;
            }

            let baseUrl;
            if (window.location.protocol === 'file:') {
                const currentPath = window.location.pathname;
                const runPath = currentPath.replace('/playground.html', '/run.html');
                baseUrl = window.location.protocol + '//' + runPath;
            } else {
                baseUrl = window.location.origin + '/run.html';
            }

            const currentData = JSON.parse(data);
            const dataUnchanged = currentDatasetKey !== 'custom' &&
                originalPresetData &&
                JSON.stringify(currentData) === JSON.stringify(originalPresetData);

            if (dataUnchanged) {
                const encodedQuery = btoa(query);
                const urlSafeQuery = encodeURIComponent(encodedQuery);
                currentShareUrl = `${baseUrl}?dataset=${currentDatasetKey}&q=${urlSafeQuery}`;
                showShareStatus('‚úì Share link generated', false);
            } else {
                const payload = JSON.stringify({ query, data });
                const compressed = pako.gzip(payload);
                const base64 = btoa(String.fromCharCode.apply(null, compressed));
                const urlSafe = encodeURIComponent(base64);
                currentShareUrl = `${baseUrl}#c=${urlSafe}`;
                showShareStatus(`‚úì Share link generated`, false);
            }

            document.getElementById('share-buttons').classList.remove('hidden');
        }

        function copyShareLink() {
            if (!currentShareUrl) return;

            navigator.clipboard.writeText(currentShareUrl).then(() => {
                showShareStatus('‚úì Link copied to clipboard!', false);
            }).catch(err => {
                showShareStatus('Failed to copy: ' + err, true);
            });
        }

        function openShareLink() {
            if (currentShareUrl) {
                window.open(currentShareUrl, '_blank');
            }
        }

        function showShareStatus(message, isError = false) {
            const statusDiv = document.getElementById('share-status');
            statusDiv.textContent = message;
            statusDiv.className = 'mt-3 text-sm px-3 py-1.5 rounded-lg animate-fade-in ' +
                (isError ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-green-50 text-green-600 border border-green-200');
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const code = codeElement.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const button = event.target.closest('.copy-code-button');
                const originalHTML = button.innerHTML;

                button.innerHTML = '<i data-lucide="check"></i> Copied!';
                button.classList.add('copied');

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }

        // Enable drag & drop for custom file upload
        const uploadSection = document.getElementById('file-upload-section');
        if (uploadSection) {
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file) {
                    const fileInput = document.getElementById('data-file-picker');
                    fileInput.files = e.dataTransfer.files;
                    loadFromFile();
                }
            });
        }

        // Apply syntax highlighting to SQL code blocks
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Main initialization function
        function initializePlayground() {
            // Check for URL params first (share links take priority)
            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlParams = urlParams.get('query') || urlParams.get('data');

            if (hasUrlParams) {
                // URL params exist - use them and clear any saved session
                loadFromUrlParams();
                clearSession();
                originalData = document.getElementById('data-textarea').value.trim();
                setupAutoSave();
                return;
            }

            // Check for saved session
            const savedSession = loadSession();
            if (savedSession && savedSession.data) {
                // Show restore banner - don't auto-restore
                showSessionRestoreBanner(savedSession);
            }

            // Load default/last selected preset dataset
            try {
                const savedDataset = localStorage.getItem('selectedDataset');
                if (savedDataset && presetDatasets[savedDataset]) {
                    document.getElementById('dataset-picker').value = savedDataset;
                    loadPresetDataset();
                }
            } catch (e) { }

            originalData = document.getElementById('data-textarea').value.trim();

            // Capture initial query state if not already set by loadPresetDataset
            if (!originalQuery) {
                const snippet = document.querySelector('codapi-snippet');
                const queryDisplay = document.getElementById('query-display');
                originalQuery = snippet?.querySelector('.snippet-code')?.textContent?.trim() ||
                    queryDisplay?.textContent?.trim() || '';
            }

            // Setup auto-save for future changes
            setupAutoSave();
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePlayground);
        } else {
            initializePlayground();
        }
    </script>

</body>

</html>