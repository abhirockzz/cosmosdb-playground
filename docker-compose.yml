services:
  # Cosmos DB vNext Emulator
  cosmosdb:
    build:
      context: ./sandboxes/cosmosdb
      dockerfile: Dockerfile
    container_name: cosmosdb
    ports:
      - "8081:8081"
      - "8080:8080"
    networks:
      - codapi-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Client image (pre-built, used by Codapi on-demand)
  cosmosdb-client:
    build:
      context: ./sandboxes/cosmosdb
      dockerfile: Dockerfile.client
    image: codapi/cosmosdb-client
    container_name: cosmosdb-client-builder
    command: /bin/true

  # Codapi Server (serves cosmosdb sandbox queries)
  codapi:
    build:
      context: .
      dockerfile: Dockerfile.codapi
    container_name: codapi-server
    ports:
      - "1313:1313"
    volumes:
      # CRITICAL: Mount Docker socket to allow spawning sibling containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount entire /tmp for code snippets (Codapi creates random subdirs)
      # Spawned containers need access to same host paths
      - /tmp:/tmp
    networks:
      - codapi-net
    depends_on:
      cosmosdb:
        condition: service_healthy
      cosmosdb-client:
        condition: service_completed_successfully
    restart: unless-stopped

  # nginx - Reverse proxy and static file serving
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
    volumes:
      # Static HTML files
      - ./playground.html:/usr/share/nginx/html/playground.html:ro
      - ./run.html:/usr/share/nginx/html/run.html:ro
      # Dataset JSON files
      - ./datasets:/usr/share/nginx/html/datasets:ro
      # nginx configuration
      - ./nginx-cosmosdb.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - codapi-net
    depends_on:
      - codapi
    restart: unless-stopped

networks:
  codapi-net:
    name: codapi-net
    driver: bridge
